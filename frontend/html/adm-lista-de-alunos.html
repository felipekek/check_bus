  <!-- TESTE PARA MODIFICAR A LISTA DE HORARIOS -->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin • Calendário de Ônibus</title>
  <style>
    :root{ --prim:#0d6efd; --ok:#1b9e4b; --warn:#e03131; --bg:#f6f8fb; --card:#fff }
    *{ box-sizing: border-box; }
    body{ margin:0; font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:#0c2437; }
    header{ position:sticky; top:0; background:var(--card); border-bottom:1px solid #e5e9f2; padding:12px 16px; display:flex; gap:12px; align-items:center; z-index:10 }
    header h1{ font-size:16px; margin:0; }
    main{ max-width:1000px; margin:16px auto; padding:0 16px; display:grid; grid-template-columns: 2fr 1fr; gap:16px; }
    .card{ background:var(--card); border:1px solid #e5e9f2; border-radius:12px; padding:16px; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .legend{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; font-size:12px }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#f0f3f9 }
    .dot{ width:12px; height:12px; border-radius:50% }
    .dot.available{ background:#dff6e4; border:1px solid #1b9e4b }
    .dot.going{ background:#d7e8ff; border:1px solid #0d6efd }
    .dot.no-bus{ background:#ffe0e0; border:1px solid #e03131 }

    .calendar-nav{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px }
    .calendar-nav button{ padding:8px 10px; border-radius:8px; border:1px solid #e5e9f2; background:#fff; cursor:pointer }
    .calendar{ display:grid; grid-template-columns: repeat(7, 1fr); gap:6px }
    .dow{ text-align:center; font-weight:600; color:#4a667d; padding:6px 0; font-size:12px }
    .day{ text-align:center; padding:10px 0; border-radius:8px; cursor:pointer; font-weight:600; border:1px solid #e5e9f2; user-select:none }
    .day.available{ background:#dff6e4; color:#145c2c; border-color:#bfe9c8 }
    .day.going{ background:#d7e8ff; color:#0b4aa8; border-color:#a9ccff }
    .day.no-bus{ background:#ffe0e0; color:#8a1c1c; border-color:#ffc2c2 }
    .day.locked{ opacity:.7; cursor:not-allowed }

    .tools .row{ margin-bottom:8px }
    .tools label{ display:flex; flex-direction:column; gap:6px; margin-bottom:8px }
    input[type="time"], select, input[type="text"], input[type="number"]{ padding:8px; border-radius:8px; border:1px solid #d9e1ea; background:#fff }
    .btn{ padding:10px 12px; border-radius:10px; border:1px solid #cfd8e3; background:#fff; cursor:pointer; font-weight:600 }
    .btn.primary{ background:var(--prim); color:#fff; border-color:var(--prim) }
    .btn.danger{ background:var(--warn); color:#fff; border-color:var(--warn) }

    .table{ width:100%; border-collapse:separate; border-spacing:0 8px }
    .table th{ text-align:left; font-size:12px; color:#4a667d }
    .table td, .table th{ padding:6px 8px }
    .rowcard{ background:#f5f9ff; border:1px solid #e0ecff; border-radius:10px }

    @media (max-width: 900px){ main{ grid-template-columns:1fr } }
  </style>
</head>
<body>
  <header>
    <h1>Admin • Calendário de Ônibus</h1>
    <div class="legend">
      <span class="pill"><span class="dot available"></span>Tem ônibus</span>
      <span class="pill"><span class="dot no-bus"></span>Sem ônibus</span>
      <span class="pill"><span class="dot going"></span>Aluno vai (lado aluno)</span>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="calendar-nav">
        <button id="prev">◀</button>
        <div><strong id="monthLabel"></strong></div>
        <button id="next">▶</button>
      </div>
      <div class="calendar" id="calendar">
        <!-- header dias da semana -->
      </div>
    </section>

    <aside class="card tools">
      <h3 style="margin-top:0">Ferramentas</h3>

      <div class="row">
        <select id="bulkWeekday">
          <option value="">Aplicar por dia da semana…</option>
          <option value="1">Segunda</option>
          <option value="2">Terça</option>
          <option value="3">Quarta</option>
          <option value="4">Quinta</option>
          <option value="5">Sexta</option>
          <option value="0">Domingo</option>
          <option value="6">Sábado</option>
        </select>
        <select id="bulkState">
          <option value="available">Tem ônibus</option>
          <option value="no_bus">Sem ônibus</option>
        </select>
        <button class="btn" id="applyWeekday">Aplicar</button>
      </div>

      <div class="row">
        <input type="date" id="rangeStart" />
        <input type="date" id="rangeEnd" />
        <select id="rangeState">
          <option value="available">Tem ônibus</option>
          <option value="no_bus">Sem ônibus</option>
        </select>
        <button class="btn" id="applyRange">Aplicar intervalo</button>
      </div>

      <hr/>
      <h4>Turnos e horários</h4>
      <table class="table">
        <thead>
          <tr><th>Turno</th><th>Saída</th><th>Chegada</th><th></th></tr>
        </thead>
        <tbody id="turnosBody"></tbody>
      </table>
      <div class="row">
        <input type="text" id="novoTurno" placeholder="Nome do turno (ex.: Manhã)"/>
        <input type="time" id="novoSaida"/>
        <input type="time" id="novoChegada"/>
        <button class="btn" id="addTurno">Adicionar turno</button>
      </div>

      <hr/>
      <div class="row">
        <button class="btn primary" id="saveMonth">Salvar mês</button>
        <button class="btn" id="loadMonth">Recarregar</button>
        <button class="btn danger" id="clearMonth">Limpar mês</button>
      </div>
      <small style="opacity:.7">Dados de demonstração são salvos no navegador (localStorage). No backend, use os endpoints sugeridos abaixo.</small>
    </aside>
  </main>

  <script>
    // ===== Admin state (simulado via localStorage) =====
    const LS_ADMIN = 'cb_admin_state';
    const LS_TURNOS = 'cb_admin_turnos';
    function ymKey(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); return `${y}-${m}` }
    function dateKey(y,m,d){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}` }
    function load(obj){ try{ return JSON.parse(localStorage.getItem(obj))||{} }catch{ return {} } }
    function save(obj,val){ localStorage.setItem(obj, JSON.stringify(val)) }

    let currentDate = new Date();
    let adminState = load(LS_ADMIN); // { 'YYYY-MM': { 'YYYY-MM-DD': 'available'|'no_bus' } }
    let turnos = (function(){ try{ return JSON.parse(localStorage.getItem(LS_TURNOS))||[
      {nome:'Manhã', saida:'06:00', chegada:'14:00'},
      {nome:'Tarde', saida:'11:30', chegada:'18:00'},
      {nome:'Noite', saida:'18:00', chegada:'21:00'}
    ] }catch{ return [] } })();

    // ===== Render calendário =====
    const cal = document.getElementById('calendar');
    const monthLabel = document.getElementById('monthLabel');

    function renderCalendar(){
      cal.innerHTML = '';
      const y = currentDate.getFullYear();
      const m = currentDate.getMonth();
      const first = new Date(y,m,1);
      const last = new Date(y,m+1,0);
      monthLabel.textContent = first.toLocaleString('pt-BR',{month:'long'}) + ' ' + y;
      const ym = ymKey(currentDate);
      if(!adminState[ym]) adminState[ym] = {};

      const dows = ['D','S','T','Q','Q','S','S'];
      dows.forEach(d => { const el=document.createElement('div'); el.textContent=d; el.className='dow'; cal.appendChild(el) })

      for(let i=0;i<first.getDay();i++){ const filler=document.createElement('div'); cal.appendChild(filler) }

      for(let d=1; d<=last.getDate(); d++){
        const date = new Date(y,m,d);
        const key = dateKey(y,m+1,d);
        const state = adminState[ym][key] || 'available';
        const el = document.createElement('div');
        el.className = `day ${state}`;
        el.textContent = d;
        el.title = `${key}`;
        el.addEventListener('click', ()=>{
          const cur = adminState[ym][key] || 'available';
          const next = cur==='available' ? 'no_bus' : 'available';
          adminState[ym][key] = next;
          save(LS_ADMIN, adminState);
          renderCalendar();
        });
        cal.appendChild(el);
      }
    }

    document.getElementById('prev').onclick = ()=>{ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar() };
    document.getElementById('next').onclick = ()=>{ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar() };

    // ===== Ferramentas em massa =====
    document.getElementById('applyWeekday').onclick = ()=>{
      const wd = document.getElementById('bulkWeekday').value;
      const state = document.getElementById('bulkState').value;
      if(wd==='') return;
      const y=currentDate.getFullYear(), m=currentDate.getMonth();
      const last = new Date(y,m+1,0).getDate();
      const ym=ymKey(currentDate);
      if(!adminState[ym]) adminState[ym] = {};
      for(let d=1; d<=last; d++){
        const dt = new Date(y,m,d);
        if(String(dt.getDay())===String(wd)){
          const k = dateKey(y,m+1,d);
          adminState[ym][k] = state;
        }
      }
      save(LS_ADMIN, adminState); renderCalendar();
    };

    document.getElementById('applyRange').onclick = ()=>{
      const s = document.getElementById('rangeStart').value;
      const e = document.getElementById('rangeEnd').value;
      const state = document.getElementById('rangeState').value;
      if(!s||!e) return;
      const start = new Date(s+'T00:00:00');
      const end = new Date(e+'T00:00:00');
      const ym = ymKey(currentDate);
      if(!adminState[ym]) adminState[ym] = {};
      for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
        if(d.getMonth()!==currentDate.getMonth() || d.getFullYear()!==currentDate.getFullYear()) continue; // limita ao mês visível
        const k = dateKey(d.getFullYear(), d.getMonth()+1, d.getDate());
        adminState[ym][k] = state;
      }
      save(LS_ADMIN, adminState); renderCalendar();
    };

    // ===== Turnos =====
    const tbody = document.getElementById('turnosBody');
    function renderTurnos(){
      tbody.innerHTML = '';
      turnos.forEach((t,i)=>{
        const tr = document.createElement('tr'); tr.className='rowcard';
        tr.innerHTML = `<td>${t.nome}</td>
                        <td><input type="time" value="${t.saida}" data-i="${i}" data-k="saida"/></td>
                        <td><input type="time" value="${t.chegada}" data-i="${i}" data-k="chegada"/></td>
                        <td><button class="btn danger" data-del="${i}">Excluir</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('input[type=time]').forEach(inp=>{
        inp.onchange = (e)=>{ const i=+e.target.dataset.i; const k=e.target.dataset.k; turnos[i][k]=e.target.value; save(LS_TURNOS, turnos) };
      });
      tbody.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.onclick = ()=>{ const i=+btn.dataset.del; turnos.splice(i,1); save(LS_TURNOS, turnos); renderTurnos() };
      })
    }
    renderTurnos();

    document.getElementById('addTurno').onclick = ()=>{
      const nome = document.getElementById('novoTurno').value.trim();
      const saida = document.getElementById('novoSaida').value;
      const chegada = document.getElementById('novoChegada').value;
      if(!nome||!saida||!chegada) return alert('Preencha nome, saída e chegada.');
      turnos.push({nome, saida, chegada}); save(LS_TURNOS, turnos); renderTurnos();
      document.getElementById('novoTurno').value=''; document.getElementById('novoSaida').value=''; document.getElementById('novoChegada').value='';
    };

    // ===== Persistência mês (simulada) =====
    document.getElementById('saveMonth').onclick = async ()=>{
      // Aqui chamaria seu backend: POST /api/servico/mes/:ym
      const ym = ymKey(currentDate);
      const payload = { ym, days: adminState[ym] || {}, turnos };
      console.log('POST /api/servico/mes/'+ym, payload);
      alert('Mês salvo localmente (abra o console para ver o payload que seria enviado).');
    };
    document.getElementById('loadMonth').onclick = async ()=>{
      // GET /api/servico/mes/:ym -> days, turnos
      renderCalendar();
    };
    document.getElementById('clearMonth').onclick = ()=>{
      const ym = ymKey(currentDate);
      if(!confirm('Limpar configurações do mês visível?')) return;
      adminState[ym] = {}; save(LS_ADMIN, adminState); renderCalendar();
    };

    // init
    renderCalendar();
  </script>
</body>
</html>
