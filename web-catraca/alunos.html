<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lista de Alunos</title>
  <link rel="stylesheet" href="../css/style.css" />
  <style>

    .alunos-container {
      max-width: 900px;
      margin: 40px auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      color: #222; 
    }
    h1 {
      text-align: center;
      margin-bottom: 24px;
      color: #004d7a;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 18px;
      background: #f8f9fa;
      border-radius: 8px;
      overflow: hidden;
      color: #222; 
    }
    th, td {
      padding: 12px 10px;
      border-bottom: 1px solid #e0e0e0;
      text-align: left;
      font-size: 15px;
    }
    th {
      background: #008793;
      color: #fff;
      font-weight: 600;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .voltar-btn {
      margin-top: 24px;
      background: #008793;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 12px 28px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
      width: auto;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .voltar-btn:hover {
      background: #00677a;
    }
    .no-data {
      text-align: center;
      color: #888;
      padding: 30px 0;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <!-- Botão de menu -->
  <button class="menu-btn" onclick="toggleMenu()">☰</button>

  <!-- Fundo escuro quando menu ativo -->
  <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

  <!-- Menu lateral -->
  <div class="sidebar" id="sidebar">
    <button onclick="location.href='home.html'">Home</button>
    <button onclick="location.href='horarios.html'">Editar Horários</button>
    <button onclick="location.href='gps.html'">Abrir GPS</button>
    <button onclick="location.href='relatorios.html'" id="btnRelatorio">Relatório</button>
    <button onclick="location.href='alunos.html'" id="btnAlunos">Lista de Alunos</button>
    <button onclick="logout()" class="logout">Sair</button>
  </div>

  <div class="alunos-container">
    <h1>Lista de Alunos</h1>
    <div style="overflow-x:auto;">
      <table id="tabelaAlunos">
        <thead>
          <tr>
            <th>Nome</th>
            <th>E-mail</th>
            <th>Instituição</th>
            <th>Último Login</th>
            <th>Horários Registrados</th>
          </tr>
        </thead>
        <tbody id="corpoTabelaAlunos">
          <tr><td colspan="5" class="no-data">Carregando alunos...</td></tr>
        </tbody>
      </table>
    </div>
    <button class="voltar-btn" onclick="window.location.href='home.html'">Voltar para Home</button>
  </div>

  <script type="module">
    import { db, auth } from "../js/firebase-config.js";
    import { collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const STAFF_EMAIL = "staff@adm.com";

    onAuthStateChanged(auth, async (user) => {
      const btnRelatorio = document.getElementById("btnRelatorio");
      const btnAlunos = document.getElementById("btnAlunos");

      if (!user || user.email !== STAFF_EMAIL) {
        // Oculta botões para não-staff
        if (btnRelatorio) btnRelatorio.style.display = "none";
        if (btnAlunos) btnAlunos.style.display = "none";
      }
      carregarAlunos();
    });

    async function carregarAlunos() {
      const corpo = document.getElementById("corpoTabelaAlunos");
      corpo.innerHTML = `<tr><td colspan="5" class="no-data">Carregando alunos...</td></tr>`;
      try {
        const alunosSnap = await getDocs(collection(db, "alunos"));
        if (alunosSnap.empty) {
          corpo.innerHTML = `<tr><td colspan="5" class="no-data">Nenhum aluno cadastrado.</td></tr>`;
          return;
        }
        corpo.innerHTML = "";
        for (const alunoDoc of alunosSnap.docs) {
          const aluno = alunoDoc.data();
          // Busca horários do aluno
          const horariosSnap = await getDocs(collection(db, "horarios", alunoDoc.id, "listaHorarios"));
          let horarios = [];
          horariosSnap.forEach(h => {
            const d = h.data();
            horarios.push(`${d.titulo || ""} ${d.horario || ""}`.trim());
          });
          // Busca último login (se existir, pode ser salvo em um campo próprio no Firestore)
          let ultimoLogin = aluno.ultimoLogin || "-";
          // Exibe linha
          corpo.innerHTML += `
            <tr>
              <td>${aluno.nome || "-"}</td>
              <td>${aluno.email || "-"}</td>
              <td>${aluno.instituicao || "-"}</td>
              <td>${ultimoLogin}</td>
              <td>${horarios.length > 0 ? horarios.join("<br>") : "-"}</td>
            </tr>
          `;
        }
      } catch (err) {
        corpo.innerHTML = `<tr><td colspan="5" class="no-data">Erro ao carregar alunos.</td></tr>`;
      }
    }

    window.logout = () => {
      signOut(auth).then(() => {
        window.location.href = "index.html";
      });
    };

    window.toggleMenu = () => {
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("overlay");
      const menuBtn = document.querySelector(".menu-btn");

      sidebar.classList.toggle("active");
      overlay.classList.toggle("active");
      menuBtn.classList.toggle("hidden");
    };
  </script>
</body>
</html>